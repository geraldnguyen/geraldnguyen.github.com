<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width">

 

  


<title>Retry WebClient Request</title>
<meta data-rh="true" property="og:url" content="https://geraldnguyen.github.io/posts/2022/12/retry-webclient-request/">
<meta data-rh="true" property="og:title" content="Retry WebClient Request">
<meta data-rh="true" name="description" content="">
<meta data-rh="true" property="og:site_name" content="Gerald Nguyen">
<meta data-rh="true" property="og:description" content="">
<meta data-rh="true" name="twitter:description" content="">
<meta data-rh="true" property="al:web:url" content="https://geraldnguyen.github.io/posts/2022/12/retry-webclient-request/">
<meta data-rh="true" property="og:type" content="article">





      <link rel="stylesheet" href="/css/main.min.c26f43265fe59e08f5f7f91bc6df440219638e2c9ed43736fd053a50a9963e69.css" integrity="sha256-wm9DJl/lngj19/kbxt9EAhljjiye1Dc2/QU6UKmWPmk=" crossorigin="anonymous">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">



      <script src="/js/main.23cd0c7d837263b9eaeb96ee2d9ccfa2969daa3fa00fa1c1fe8701a9b87251a1.js" integrity="sha256-I80MfYNyY7nq65buLZzPopadqj&#43;gD6HB/ocBqbhyUaE=" crossorigin="anonymous"></script>


</head>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-HRKMT2G8N9"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-HRKMT2G8N9');
</script>

<body class="container-xxl">
  <div class="top-menu">
    
  <nav>
    <ul class="nav">
    <li class="nav-item">
      <a class="nav-link" href="/">Home</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="/pages/about/">About</a>
    </li>
    </ul>
  </nav>

  </div>

  <header>
    <div class="header-content">
      


  <div class="categories-list">
    <ul>
        <li><a href="/categories/software-development/">Software Development</a></li>
    </ul>
  </div>


<h1>Retry WebClient Request</h1>

<h2 class="subtitle">Retrying a WebClient request using RetrySpec, and unit-testing it</h2>





<div class="story-profile-brief d-flex flex-row">
  <div class="me-2">
    
    <img alt="Gerald Nguyen" class="profile-thumbnail rounded-circle"
          src="https://geraldnguyen.github.io/geraldnguyen-profile-thumbnail.jpg" width="44"
          height="44" loading="lazy" data-testid="authorPhoto">
    
  </div>
  <div>
    <div>
      <a rel="noopener follow" href="https://geraldnguyen.github.io/">
        Gerald Nguyen
      </a>
    </div>
    <div>
      <span>4 min read</span>
      <span>·</span>
      <span><time datetime="2022-12-30T09:19:42&#43;01:00">December 30, 2022</time></span>
    </div>
  </div>
            
</div>  


    </div>
    <div class="header-nav">
      
  
  <a href="/posts/2022/12/regional-economic-development-in-vietnam-reform-reorder/">Previous</a>
  
  <span> | </span>
  
  <a href="/posts/2023/01/writers-please-go-to-sleep-earlier/">Next</a>
  


    </div>
    
  </header>

  <main>
    <div class="bd-toc">
      
  <div class="toc-header">On this page</div>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#problem-statement">Problem Statement</a></li>
    <li><a href="#retry-unchanged">Retry unchanged</a></li>
    <li><a href="#retry-with-modification">Retry with modification</a></li>
    <li><a href="#sample-codes">Sample codes</a></li>
  </ul>
</nav>

    </div>
    <div class="bd-main">
      

  <h1 id="problem-statement">Problem Statement</h1>
<p>Sometimes web request fails, for whatever reason, and you need to retry it</p>
<p>Let’s simulate a failed request scenario in a unit test. In the below code, the <code>webClient</code> attempts to submit a <code>GET</code> request to <code>/employee/100</code> (stored in constant <code>PATH</code>). We mocked the backend server to fail with common status codes such as <code>BAD_REQUEST</code>, <code>UNAUTHORIZED</code> and validate that the client throws <code>WebClientResponseException</code> upon receiving such statuses.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@ParameterizedTest</span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#3c5d5d;font-weight:bold">@EnumSource</span>(value<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>HttpStatus.<span style="color:#008080">class</span>,<span style="color:#bbb"> </span>mode<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>EnumSource.<span style="color:#008080">Mode</span>.<span style="color:#008080">INCLUDE</span>,<span style="color:#bbb"> </span>names<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>{<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#d14">&#34;BAD_REQUEST&#34;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#34;UNAUTHORIZED&#34;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#34;FORBIDDEN&#34;</span>,<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#d14">&#34;SERVICE_UNAVAILABLE&#34;</span>,<span style="color:#bbb"> </span><span style="color:#d14">&#34;INTERNAL_SERVER_ERROR&#34;</span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>})<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">throwExceptionWhenReceiveNon200Response</span>(HttpStatus<span style="color:#bbb"> </span>status)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException<span style="color:#bbb"> </span>{<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// request  </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">var</span><span style="color:#bbb"> </span>webClient<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>WebClient.<span style="color:#008080">builder</span>().<span style="color:#008080">baseUrl</span>(baseUrl).<span style="color:#008080">build</span>();<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">var</span><span style="color:#bbb"> </span>request<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>webClient.<span style="color:#008080">get</span>()<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>.<span style="color:#008080">uri</span>(PATH)<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>.<span style="color:#008080">retrieve</span>()<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>.<span style="color:#008080">bodyToMono</span>(String.<span style="color:#008080">class</span>);<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// response to first request with fail status  </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>mockBackEnd.<span style="color:#008080">enqueue</span>(<span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>MockResponse().<span style="color:#008080">setResponseCode</span>(status.<span style="color:#008080">value</span>()));<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// assert that exception thrown due to non-200 response  </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">var</span><span style="color:#bbb"> </span>ex<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>assertThrows(WebClientResponseException.<span style="color:#008080">class</span>,<span style="color:#bbb"> </span>()<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#bbb"> </span>request.<span style="color:#008080">block</span>());<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>assertEquals(status,<span style="color:#bbb"> </span>ex.<span style="color:#008080">getStatusCode</span>());<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// extra assert that the path is correct  </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>assertEquals(PATH,<span style="color:#bbb"> </span>mockBackEnd.<span style="color:#008080">takeRequest</span>().<span style="color:#008080">getPath</span>());<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><h1 id="retry-unchanged">Retry unchanged</h1>
<p>The easiest task is just retrying with the same request details.</p>
<p>We can use <a href="https://projectreactor.io/docs/core/release/api/reactor/core/publisher/Mono.html#retryWhen-reactor.util.retry.Retry-"><code>retryWhen</code></a>(<a href="https://projectreactor.io/docs/core/release/api/reactor/util/retry/Retry.html"><code>Retry</code></a> <code>retrySpec)</code> to configure a retry specification in the form of an <a href="https://projectreactor.io/docs/core/release/api/reactor/util/retry/RetrySpec.html"><code>RetrySpec</code></a> instance. <code>RetrySpec</code> supports various static builder methods that we can use to quickly set one up. In the example below, we set the maximum number of retries to 1 by calling <code>.max(1)</code>. In a similar manner, we specify a filtering condition for retry by invoking <code>.filter(e -&gt; e instanceof WebClientResponseException.ServiceUnavailable))</code></p>
<p>Let’s see it in action. First off, we need to mock 2 responses:</p>
<ul>
<li>One for the original request. It should fail.</li>
<li>And one for the retry request. It should succeed to keep our test fast.</li>
</ul>
<p>Then, as we can see from <code>assertDoesNotThrow(() -&gt; requestWithRetry.block())</code>, our <code>requestWithRetry</code> instance does not result in any exception when invoked. And there are indeed 2 requests sent, a failed original request and a successful retried request.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Test</span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">retryUnChanged</span>()<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException<span style="color:#bbb"> </span>{<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// request  </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">var</span><span style="color:#bbb"> </span>webClient<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>WebClient.<span style="color:#008080">builder</span>().<span style="color:#008080">baseUrl</span>(baseUrl).<span style="color:#008080">build</span>();<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">var</span><span style="color:#bbb"> </span>request<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>webClient.<span style="color:#008080">get</span>()<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>.<span style="color:#008080">uri</span>(PATH)<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>.<span style="color:#008080">retrieve</span>()<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>.<span style="color:#008080">bodyToMono</span>(String.<span style="color:#008080">class</span>)<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>;<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">var</span><span style="color:#bbb"> </span>requestWithRetry<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>request.<span style="color:#008080">retryWhen</span>(RetrySpec.<span style="color:#008080">max</span>(1)<span style="color:#bbb">        </span><span style="color:#998;font-style:italic">// retry at most once  </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>.<span style="color:#008080">filter</span>(e<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#bbb"> </span>e<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">instanceof</span><span style="color:#bbb"> </span>WebClientResponseException.<span style="color:#008080">ServiceUnavailable</span>));<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// response to first request with a SERVICE_UNAVAILABLE  </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>mockBackEnd.<span style="color:#008080">enqueue</span>(<span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>MockResponse().<span style="color:#008080">setResponseCode</span>(HttpStatus.<span style="color:#008080">SERVICE_UNAVAILABLE</span>.<span style="color:#008080">value</span>()));<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// response to 2nd request with 200  </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>mockBackEnd.<span style="color:#008080">enqueue</span>(<span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>MockResponse().<span style="color:#008080">setBody</span>(<span style="color:#d14">&#34;Successful!&#34;</span>));<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// no more WebClientResponseException.ServiceUnavailable exception  </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>assertDoesNotThrow(()<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#bbb"> </span>requestWithRetry.<span style="color:#008080">block</span>());<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// assert that there are 2 requests sent  </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>assertEquals(PATH,<span style="color:#bbb"> </span>mockBackEnd.<span style="color:#008080">takeRequest</span>().<span style="color:#008080">getPath</span>());<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>assertEquals(PATH,<span style="color:#bbb"> </span>mockBackEnd.<span style="color:#008080">takeRequest</span>().<span style="color:#008080">getPath</span>());<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><h1 id="retry-with-modification">Retry with modification</h1>
<p>It is harder to retry with modification.</p>
<p>Let’s consider a common scenario in OAuth-protected API invocation. After obtaining a valid OAuth token, our client can immediately make multiple API calls to the resource server. However, after some time, the token expired and our client’s API calls start to fail with HTTP 401 errors. When it first happens, we need to refresh the token and retry the request with the refreshed valid token.</p>
<p>Assuming we delegate the storing and refreshing of tokens to another class, it is logical to invoke the <code>refreshToken()</code> method before the retry.</p>
<p>Similar to retrying unchanged, we create an <code>requestWithRetry</code> instance with the help of <a href="https://projectreactor.io/docs/core/release/api/reactor/core/publisher/Mono.html#retryWhen-reactor.util.retry.Retry-"><code>retryWhen</code></a>(<a href="https://projectreactor.io/docs/core/release/api/reactor/util/retry/Retry.html">Retry</a> <code>retrySpec)</code> method. A difference here is the presence of <code>.doBeforeRetry(retrySignal -&gt; tokenSupplier.refreshToken())</code> expression which executes <code>tokenSupplier.refreshToken()</code> just before retrying.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">TokenSupplier</span><span style="color:#bbb"> </span>{<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>String<span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">getToken</span>();<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">refreshToken</span>();<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>...<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">var</span><span style="color:#bbb"> </span>requestWithRetry<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>request.<span style="color:#008080">retryWhen</span>(RetrySpec.<span style="color:#008080">max</span>(1)<span style="color:#bbb">        </span><span style="color:#998;font-style:italic">// retry at most once  </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>.<span style="color:#008080">doBeforeRetry</span>(retrySignal<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#bbb"> </span>tokenSupplier.<span style="color:#008080">refreshToken</span>())<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>.<span style="color:#008080">filter</span>(e<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#bbb"> </span>e<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">instanceof</span><span style="color:#bbb"> </span>WebClientResponseException.<span style="color:#008080">Unauthorized</span>));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Done<span style="color:#000;font-weight:bold">?</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">**</span>Not<span style="color:#bbb"> </span>quite<span style="color:#000;font-weight:bold">**</span>.<span style="color:#bbb"> </span>The<span style="color:#bbb"> </span>below<span style="color:#bbb"> </span>does<span style="color:#bbb"> </span>not<span style="color:#bbb"> </span>work<span style="color:#bbb"> </span>as<span style="color:#bbb"> </span><span style="color:#a61717;background-color:#e3d2d2">`</span>webClient<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#bbb"> </span>probably<span style="color:#bbb"> </span>reused<span style="color:#bbb"> </span>the<span style="color:#bbb"> </span>original<span style="color:#bbb"> </span>request<span style="color:#bbb"> </span>instance<span style="color:#bbb"> </span>thus<span style="color:#bbb"> </span>not<span style="color:#bbb"> </span>submitting<span style="color:#bbb"> </span>the<span style="color:#bbb"> </span>refreshed<span style="color:#bbb"> </span>token<span style="color:#bbb"> </span>obtained<span style="color:#bbb"> </span>when<span style="color:#bbb"> </span>we<span style="color:#bbb"> </span><span style="color:#a61717;background-color:#e3d2d2">`</span>doBeforeRetry<span style="color:#a61717;background-color:#e3d2d2">`</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">var</span><span style="color:#bbb"> </span>request<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>webClient.<span style="color:#008080">get</span>()<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>.<span style="color:#008080">uri</span>(PATH)<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>.<span style="color:#008080">headers</span>(headers<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#bbb"> </span>headers.<span style="color:#008080">set</span>(HttpHeaders.<span style="color:#008080">AUTHORIZATION</span>,<span style="color:#bbb"> </span>tokenSupplier.<span style="color:#008080">getToken</span>()))<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>.<span style="color:#008080">retrieve</span>()<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>.<span style="color:#008080">bodyToMono</span>(String.<span style="color:#008080">class</span>)<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>;<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">var</span><span style="color:#bbb"> </span>requestWithRetry<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>request.<span style="color:#008080">retryWhen</span>(RetrySpec.<span style="color:#008080">max</span>(1)<span style="color:#bbb">        </span><span style="color:#998;font-style:italic">// retry at most once  </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>.<span style="color:#008080">doBeforeRetry</span>(retrySignal<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#bbb"> </span>tokenSupplier.<span style="color:#008080">refreshToken</span>())<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>.<span style="color:#008080">filter</span>(e<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#bbb"> </span>e<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">instanceof</span><span style="color:#bbb"> </span>WebClientResponseException.<span style="color:#008080">Unauthorized</span>));<span style="color:#bbb">
</span></span></span></code></pre></div><p>The solution is to re-create the request in each retry with the <a href="https://projectreactor.io/docs/core/release/api/reactor/core/publisher/Mono.html#defer-java.util.function.Supplier-"><code>Mono.defer</code></a> method. This ensures that each request is created fresh with the current valid token. The above should be written as below — notice the entire request-creation expression is wrapped inside <code>Mono.defer()</code> method call:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">var</span><span style="color:#bbb"> </span>request<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>Mono.<span style="color:#008080">defer</span>(()<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#bbb"> </span>webClient.<span style="color:#008080">get</span>()<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>.<span style="color:#008080">uri</span>(PATH)<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>.<span style="color:#008080">headers</span>(headers<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#bbb"> </span>headers.<span style="color:#008080">set</span>(HttpHeaders.<span style="color:#008080">AUTHORIZATION</span>,<span style="color:#bbb"> </span>tokenSupplier.<span style="color:#008080">getToken</span>()))<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>.<span style="color:#008080">retrieve</span>()<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>.<span style="color:#008080">bodyToMono</span>(String.<span style="color:#008080">class</span>)<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>);<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">var</span><span style="color:#bbb"> </span>requestWithRetry<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>request.<span style="color:#008080">retryWhen</span>(RetrySpec.<span style="color:#008080">max</span>(1)<span style="color:#bbb">        </span><span style="color:#998;font-style:italic">// retry at most once  </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>.<span style="color:#008080">doBeforeRetry</span>(retrySignal<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#bbb"> </span>tokenSupplier.<span style="color:#008080">refreshToken</span>())<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>.<span style="color:#008080">filter</span>(e<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#bbb"> </span>e<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">instanceof</span><span style="color:#bbb"> </span>WebClientResponseException.<span style="color:#008080">Unauthorized</span>));<span style="color:#bbb">
</span></span></span></code></pre></div><p>The entire unit test is below for your reference:</p>
<figure><img src="/posts/2022/12/retry-webclient-request/1_jGPgtzh641BG9RrIAv1A3w.webp"
    alt="All tests passed (screenshot)"><figcaption>
      <p>All tests passed (screenshot)</p>
    </figcaption>
</figure>

<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">TokenSupplier</span><span style="color:#bbb"> </span>{<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>String<span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">getToken</span>();<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">refreshToken</span>();<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#3c5d5d;font-weight:bold">@Test</span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">retryIf401WithDifferentToken</span>()<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">throws</span><span style="color:#bbb"> </span>InterruptedException<span style="color:#bbb"> </span>{<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>String<span style="color:#bbb"> </span>firstToken<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#d14">&#34;FIRST TOKEN&#34;</span>;<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>String<span style="color:#bbb"> </span>secondToken<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#d14">&#34;SECOND TOKEN&#34;</span>;<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>TokenSupplier<span style="color:#bbb"> </span>tokenSupplier<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>spy(<span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>TokenSupplier()<span style="color:#bbb"> </span>{<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>String<span style="color:#bbb"> </span>currentToken<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>firstToken;<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#3c5d5d;font-weight:bold">@Override</span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">getToken</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span>currentToken;<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#3c5d5d;font-weight:bold">@Override</span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#900;font-weight:bold">refreshToken</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>currentToken<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>secondToken;<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>}<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>});<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// request  </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">var</span><span style="color:#bbb"> </span>webClient<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>WebClient.<span style="color:#008080">builder</span>().<span style="color:#008080">baseUrl</span>(baseUrl).<span style="color:#008080">build</span>();<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">var</span><span style="color:#bbb"> </span>request<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>Mono.<span style="color:#008080">defer</span>(()<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#bbb"> </span>webClient.<span style="color:#008080">get</span>()<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>.<span style="color:#008080">uri</span>(PATH)<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>.<span style="color:#008080">headers</span>(headers<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#bbb"> </span>headers.<span style="color:#008080">set</span>(HttpHeaders.<span style="color:#008080">AUTHORIZATION</span>,<span style="color:#bbb"> </span>tokenSupplier.<span style="color:#008080">getToken</span>()))<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>.<span style="color:#008080">retrieve</span>()<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>.<span style="color:#008080">bodyToMono</span>(String.<span style="color:#008080">class</span>)<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>);<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">var</span><span style="color:#bbb"> </span>requestWithRetry<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>request.<span style="color:#008080">retryWhen</span>(RetrySpec.<span style="color:#008080">max</span>(1)<span style="color:#bbb">        </span><span style="color:#998;font-style:italic">// retry at most once  </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>.<span style="color:#008080">doBeforeRetry</span>(retrySignal<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#bbb"> </span>tokenSupplier.<span style="color:#008080">refreshToken</span>())<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>.<span style="color:#008080">filter</span>(e<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#bbb"> </span>e<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">instanceof</span><span style="color:#bbb"> </span>WebClientResponseException.<span style="color:#008080">Unauthorized</span>));<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// response to first request with a 401  </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>mockBackEnd.<span style="color:#008080">enqueue</span>(<span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>MockResponse().<span style="color:#008080">setResponseCode</span>(HttpStatus.<span style="color:#008080">UNAUTHORIZED</span>.<span style="color:#008080">value</span>()));<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// response to 2nd request with 200  </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>mockBackEnd.<span style="color:#008080">enqueue</span>(<span style="color:#000;font-weight:bold">new</span><span style="color:#bbb"> </span>MockResponse().<span style="color:#008080">setBody</span>(<span style="color:#d14">&#34;Successful!&#34;</span>));<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// no more WebClientResponseException.Unauthorized exception  </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>assertDoesNotThrow(()<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">-&gt;</span><span style="color:#bbb"> </span>requestWithRetry.<span style="color:#008080">block</span>());<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// assert that first request failed with a 401 with firstToken sent  </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>RecordedRequest<span style="color:#bbb"> </span>recordedRequest<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>mockBackEnd.<span style="color:#008080">takeRequest</span>();<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>assertEquals(firstToken,<span style="color:#bbb"> </span>recordedRequest.<span style="color:#008080">getHeader</span>(HttpHeaders.<span style="color:#008080">AUTHORIZATION</span>));<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// assert that 2nd request passed with secondToken sent  </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>recordedRequest<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>mockBackEnd.<span style="color:#008080">takeRequest</span>();<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>assertEquals(secondToken,<span style="color:#bbb"> </span>recordedRequest.<span style="color:#008080">getHeader</span>(HttpHeaders.<span style="color:#008080">AUTHORIZATION</span>));<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// verify that tokenSupplier is invoked  </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>verify(tokenSupplier,<span style="color:#bbb"> </span>times(2)).<span style="color:#008080">getToken</span>();<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">//  twice  </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>verify(tokenSupplier).<span style="color:#008080">refreshToken</span>();<span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><h1 id="sample-codes">Sample codes</h1>
<p>Available in my <a href="https://github.com/geraldnguyen/kitchensink/blob/main/springweb/src/test/java/com/example/springweb/webclient/RetriableRequestTest.java">GitHub</a>.</p>

  
  
  <div class="tags-list">
    <ul>
        <li><a href="/tags/java/">Java</a></li>
        <li><a href="/tags/spring/">Spring</a></li>
        <li><a href="/tags/web-development/">Web Development</a></li>
        <li><a href="/tags/unit-testing/">Unit Testing</a></li>
        <li><a href="/tags/programming/">Programming</a></li>
    </ul>
  </div>


    </div>
    
  </main>
  <footer>
    <p>Copyright 2024. All rights reserved.</p>

  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>

</body>
</html>
